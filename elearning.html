<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>研究倫理eラーニング受講 | 湘南中央大学</title>
  <script>
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      alert('認証セッションがありません。ログインしてください。');
      window.location.href = 'login.html?from=elearning.html';
    }
  </script>
  <style>
    :root { --primary-color: #0b2a44; --bg-color: #f8f9fa; }
    body { margin: 0; font-family: sans-serif; background: var(--bg-color); color: #333; }
    header { background: var(--primary-color); color: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; }
    
    .container { max-width: 800px; margin: 40px auto; padding: 0 20px; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 30px; margin-bottom: 20px; }

    /* メニュー画面 */
    .course-item { 
      display: flex; justify-content: space-between; align-items: center; 
      padding: 20px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px;
    }
    .course-info h3 { margin: 0 0 5px; font-size: 16px; color: var(--primary-color); }
    .status-tag { font-size: 11px; font-weight: bold; padding: 3px 8px; border-radius: 4px; margin-right: 10px; }
    .status-yet { background: #eee; color: #777; }
    .status-done { background: #e8f5e9; color: #2e7d32; }

    /* 受講画面 */
    #study-view { display: none; }
    .progress-bar { background: #eee; height: 8px; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
    .progress-inner { background: #d4af37; height: 100%; width: 0%; transition: width 0.3s; }
    .quiz-area { background: #f9f9f9; padding: 25px; border-radius: 8px; margin: 20px 0; border-left: 5px solid var(--primary-color); }
    .option { display: block; margin: 12px 0; padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; }

    .btn-action { 
      background: var(--primary-color); color: white; border: none; padding: 15px 20px; 
      border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 15px; width: 100%;
    }
    .btn-action:hover { opacity: 0.8; }
    .back-link { display: inline-block; margin-top: 20px; color: #666; font-size: 13px; text-decoration: none; cursor: pointer; }
  </style>
</head>
<body>

<header>
  <strong>研究倫理 eラーニング受講ポータル</strong>
  <div id="userDisp" style="font-size: 14px;"></div>
</header>

<div class="container">
  
  <div id="menu-view">
    <div class="card">
      <h2 style="margin-top:0;">受講コース選択</h2>
      <p style="font-size: 14px; color: #666;">すべての問題を正解すると受講完了となります。</p>
      <div id="course-list"></div>
      <div style="text-align: center; margin-top: 20px;">
        <a href="ethics.html" class="back-link">研究倫理トップへ戻る</a>
      </div>
    </div>
  </div>

  <div id="study-view">
    <div class="card">
      <div class="progress-bar"><div id="progress-inner" class="progress-inner"></div></div>
      <h2 id="current-title">講習タイトル</h2>
      <p id="step-counter" style="font-size: 14px; color: #d4af37; font-weight: bold;"></p>
      
      <div class="quiz-area">
        <p><strong id="current-q">問題文</strong></p>
        <div id="options-area"></div>
      </div>

      <button class="btn-action" onclick="checkAnswer()">回答を提出する</button>
      <br>
      <span class="back-link" onclick="showMenu()">← メニューに戻る（中断）</span>
    </div>
  </div>

</div>

<script>
  // 講習データ（各項目に3問ずつ）
  const courseData = {
    fund: { 
      title: "公的研究費の適切な利用", 
      steps: [
        { q: "研究費で購入した備品を、一時的に私的な活動に利用することは認められますか？", options: ["はい", "いいえ"], correct: 1 },
        { q: "余った研究費を業者に預けて、翌年度に消耗品を購入する「預け金」は許されますか？", options: ["はい", "いいえ"], correct: 1 },
        { q: "学会出張の際、実際には宿泊していないのに宿泊費を請求する行為は何にあたりますか？", options: ["節約", "カラ出張（不正請求）"], correct: 1 }
      ]
    },
    human: { 
      title: "人を対象とする研究倫理", 
      steps: [
        { q: "研究対象者から得た同意は、いつでも対象者の意思で撤回可能であるべきですか？", options: ["はい", "いいえ"], correct: 0 },
        { q: "研究で得られた個人情報を、本人の許可なく他の研究に再利用してもよいですか？", options: ["はい", "いいえ"], correct: 1 },
        { q: "医学的研究において、対象者に生じるリスクは利益を上回ってもよいですか？", options: ["はい", "いいえ"], correct: 1 }
      ]
    },
    animal: { 
      title: "動物実験の適正な実施", 
      steps: [
        { q: "できる限り麻酔薬を用い、実験動物の苦痛を軽減することを何と呼びますか？", options: ["Reduction（削減）", "Refinement（洗練）"], correct: 1 },
        { q: "コンピュータシミュレーション等で、動物を使わない方法に置き換えることを何と言いますか？", options: ["Replacement（代替）", "Reduction（削減）"], correct: 0 },
        { q: "3Rの原則に含まれないものはどれですか？", options: ["Replacement", "Recycle"], correct: 1 }
      ]
    }
  };

  let activeCourseId = null;
  let currentStep = 0;

  window.onload = function() {
    document.getElementById('userDisp').innerText = localStorage.getItem('currentUserName') + " 様";
    showMenu();
  };

  function showMenu() {
    document.getElementById('menu-view').style.display = 'block';
    document.getElementById('study-view').style.display = 'none';
    const list = document.getElementById('course-list');
    list.innerHTML = '';
    Object.keys(courseData).forEach(id => {
      const done = localStorage.getItem('isDone_' + id) === 'true';
      const item = document.createElement('div');
      item.className = 'course-item';
      item.innerHTML = `
        <div class="course-info">
          <span class="status-tag ${done ? 'status-done' : 'status-yet'}">${done ? '受講済' : '未受講'}</span>
          <h3>${courseData[id].title}</h3>
        </div>
        <button class="btn-action" style="width:auto;" onclick="startCourse('${id}')">${done ? '再受講' : '受講する'}</button>
      `;
      list.appendChild(item);
    });
  }

  function startCourse(id) {
    activeCourseId = id;
    currentStep = 0;
    document.getElementById('menu-view').style.display = 'none';
    document.getElementById('study-view').style.display = 'block';
    updateQuiz();
  }

  function updateQuiz() {
    const data = courseData[activeCourseId];
    const quiz = data.steps[currentStep];
    const totalSteps = data.steps.length;

    document.getElementById('current-title').innerText = data.title;
    document.getElementById('step-counter').innerText = `問題 ${currentStep + 1} / ${totalSteps}`;
    document.getElementById('current-q').innerText = quiz.q;
    
    // プログレスバー更新
    document.getElementById('progress-inner').style.width = ((currentStep) / totalSteps * 100) + "%";

    const optArea = document.getElementById('options-area');
    optArea.innerHTML = '';
    quiz.options.forEach((opt, index) => {
      optArea.innerHTML += `<label class="option"><input type="radio" name="quiz" value="${index}"> ${opt}</label>`;
    });
  }

  function checkAnswer() {
    const selected = document.querySelector('input[name="quiz"]:checked');
    if (!selected) { alert("回答を選択してください。"); return; }

    const data = courseData[activeCourseId];
    if (parseInt(selected.value) === data.steps[currentStep].correct) {
      currentStep++;
      if (currentStep < data.steps.length) {
        alert("正解！次の問題に進みます。");
        updateQuiz();
      } else {
        alert("全問正解です！このコースを完了しました。");
        localStorage.setItem('isDone_' + activeCourseId, 'true');
        const allDone = Object.keys(courseData).every(id => localStorage.getItem('isDone_' + id) === 'true');
        if(allDone) localStorage.setItem('isEthicsDone', 'true');
        showMenu();
      }
    } else {
      alert("不正解です。もう一度考えてください。");
    }
  }
</script>

</body>
</html>
